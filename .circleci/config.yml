version: 2.1

jobs:
  run_tests:
    docker:
      - image: python:3.12.0a4-alpine3.17  # Определение Docker образа для среды выполнения тестов
    steps:
      - checkout  # Клонирование репозитория в среду выполнения CircleCI

      # Настройка среды выполнения, включая установку необходимых пакетов и инструментов
      - run:
          name: Setup environment
          command: |
            apk add curl jq  # Установка curl и jq для обработки HTTP запросов и данных JSON
            apk update  # Обновление списка пакетов
            apk add --no-cache chromium chromium-chromedriver tzdata  # Установка Chromium и его WebDriver
            wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub  # Добавление ключа для glibc
            wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.30-r0/glibc-2.30-r0.apk  # Загрузка glibc
            wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.30-r0/glibc-bin-2.30-r0.apk  # Загрузка бинарных файлов glibc
            apk add --no-cache curl openjdk11-jre  # Установка Java Runtime Environment
            curl -o allure-2.13.8.tgz -Ls https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.13.8/allure-commandline-2.13.8.tgz  # Загрузка Allure
            tar -zxvf allure-2.13.8.tgz -C /opt/  # Распаковка Allure
            ln -s /opt/allure-2.13.8/bin/allure /usr/bin/allure  # Создание символической ссылки для Allure
            rm allure-2.13.8.tgz  # Удаление архива Allure после установки

      # Установка зависимостей Python из файла requirements.txt
      - run:
          name: Install dependencies
          command: |
            pip install -r requirements.txt

      # Запуск тестов с передачей переменных окружения
      - run:
          name: Run tests
          command: |
            STAGE=dev BROWSER=chrome pytest -sv --alluredir=allure-results --junitxml=test-results/junit.xml || true

      # Восстановление кэша с предыдущих сборок для Allure истории
      - restore_cache:
          keys:
            - allure-history-{{ .Branch }}-

      # Подготовка истории Allure для текущей сборки
      - run:
          name: Prepairing of Allure History
          command: |
            if [ -d "allure-report/history" ]; then
              mkdir -p allure-results/history
              cp -r allure-report/history allure-results/
            else
              echo "No history to restore"

      # Получение ID Job из CircleCI через API для использования в отчетах
      - run:
          name: Get CircleCI Job ID
          command: |
            curl -H "Circle-Token: ${CIRCLECI_API_TOKEN}" "https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/job" > jobs.json
            JOB_ID=$(cat jobs.json | jq -r '.items[] | select(.name=="run_tests").id')  # Извлечение Job ID для текущей задачи
            echo "export CIRCLE_JOB_ID=$JOB_ID" >> $BASH_ENV
            source $BASH_ENV

      # Установка переменных окружения для Allure отчета
      - run:
          name: Setup Allure env variables
          command: |
            echo "Branch=$CIRCLE_BRANCH" > allure-results/environment.properties
            echo "Commit=$CIRCLE_SHA1" >> allure-results/environment.properties
            echo "{\"name\": \"CircleCI\", \"type\": \"circleci\", \"url\": \"$CIRCLE_REPOSITORY_URL\", \"buildOrder\": $CIRCLE_BUILD_NUM, \"buildName\": \"$CIRCLE_BRANCH\", \"buildUrl\": \"$CIRCLE_BUILD_URL\", \"reportUrl\": \"URL отчета\", \"reportName\": \"Отчет о тестировании\"}" > allure-results/executor.json

      # Генерация Allure отчета
      - run:
          name: Generate Allure report
          command: |
            allure generate allure-results --clean -o allure-report

      # Сохранение кэша истории Allure
      - save_cache:
          paths:
            - allure-report/history
          key: allure-history-{{ .Branch }}-{{ epoch }}

      # Сохранение артефактов (Allure отчет)
      - store_artifacts:
          path: allure-report
          destination: allure-report

      # Сохранение результатов тестов
      - store_test_results:
          path: test-results

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - run_tests